@startuml
skinparam defaultFontName "DejaVu Sans"
autonumber

actor "Customer" as Client
participant Screen
participant Keypad
participant CardReader
participant "ATMController" as Controller
participant "IBankingService" as Bank
participant "CashDispenser" as Dispenser
participant "ReceiptPrinter" as Printer
participant "MenuHandler" as Menu

Client -> CardReader : Insert card
CardReader -> Controller : ReadCard(cardData)

loop Up to 3 attempts (BR-AUTH-01)
  Controller -> Keypad : Request PIN (timeout 60s)
  alt Timeout (BR-SESSION-01)
    Controller -> Screen : Session timeout
    return
  else Entered PIN
    Keypad --> Controller : Pin
    Controller -> Bank : Authenticate(cardData, pin)
    alt Auth OK
      break
    else Auth failed
      Controller -> Screen : Wrong PIN
    end
  end
end

alt Auth failed 3 times (BR-AUTH-02)
  Controller -> Screen : Card blocked/retained
  return
else Authenticated
  Controller -> Menu : GetUserActionChoice()
  Menu --> Controller : UserAction.Withdraw
  Controller -> Screen : Enter amount (timeout 60s)
  Controller -> Keypad : Input amount
  alt Timeout (BR-SESSION-01)
    Controller -> Screen : Timeout, back to menu
  else Entered amount
    Keypad --> Controller : amount
    alt Not enough cash in ATM (BR-ATM-01)
      Controller -> Screen : Declined: ATM cash insufficient
    else ATM can dispense
      Controller -> Bank : ExecuteWithdrawal(accountId, amount)
      alt Declined: insufficient funds (BR-LIMIT-01)
        Controller -> Screen : Declined: insufficient funds
      else Declined: daily limit (BR-LIMIT-02)
        Controller -> Screen : Declined: daily limit exceeded
      else Approved
        Controller -> Dispenser : DispenseCash(amount)
        opt Print receipt on request
          Controller -> Printer : PrintReceipt("Withdrawn: ...")
        end
      end
    end
  end
end
@enduml 